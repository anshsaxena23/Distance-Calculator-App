events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    server {
        # Nginx listens on port 80 inside the container
        listen 80;
        server_name localhost;

        location = /favicon.ico {
            # Check if the favicon exists in the root of the mounted directory
            root /usr/share/nginx/html;
            
            # If the favicon file is found ($uri), serve it. 
            # If it's NOT found, return a 204 No Content status, which tells 
            # the browser to stop trying, thus breaking the infinite loop.
            try_files $uri =204; 
        }

        # --- 1. React Frontend Static Files ---
        location / {
            root /usr/share/nginx/html;
            index index.html;
            
            # This is the crucial fix for Single Page Applications (SPAs).
            # It tries to serve the file directly, then treats it as a directory,
            # and finally serves /index.html if the file is not found, 
            # allowing React Router to handle the URL.
            try_files $uri $uri/ /index.html;
        }
        
        # --- 2. FastAPI Backend API Proxy ---
        location /api/ {
            # Proxy the request to the FastAPI service named 'app' on port 8000.
            # The 'http://app:8000' is the Docker internal network address.
            proxy_pass http://app:8000/; 
            
            # Add headers for proper request handling by the backend
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- Optional: Default error page ---
        error_page 500 502 503 504  /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
}